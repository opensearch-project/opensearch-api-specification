name: Proto Compatibility Check

on:
  pull_request:
    paths:
      - 'spec/**'

jobs:
  build-spec:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate merged OpenAPI spec
        run: npm run merge -- --source ./spec --output ./build/opensearch-openapi.yaml

      - name: Upload OpenAPI spec artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: ./build/opensearch-openapi.yaml
          retention-days: 7

  compatibility-report:
    needs: build-spec
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: opensearch-project/opensearch-protobufs
          ref: main

      - name: Download OpenAPI spec artifact
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec
          path: ./specs

      - name: Validate artifact
        run: |
          if [ ! -f "./specs/opensearch-openapi.yaml" ]; then
            echo "Error: opensearch-openapi.yaml not found in artifact"
            exit 1
          fi
          cp ./specs/opensearch-openapi.yaml ./opensearch-openapi.yaml

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Run Proto Conversion
        timeout-minutes: 15
        run: |
          set -e
          npm ci
          npm run preprocessing -- --opensearch-version "3.0.0" || true

      - name: Clone Protobuf Generator Repository
        timeout-minutes: 10
        run: |
          set -e
          git clone https://github.com/OpenAPITools/openapi-generator cloned-repo
          cd cloned-repo
          git checkout 6699ecd9d2f4e0868f23bb36566ea03cd1230e6a

      - name: Build Protobuf Generator Tool
        timeout-minutes: 20
        run: |
          set -e
          cd cloned-repo
          ./mvnw clean package -DskipTests

      - name: Convert to Protobuf
        timeout-minutes: 15
        run: |
          set -e
          java -jar cloned-repo/modules/openapi-generator-cli/target/openapi-generator-cli.jar generate \
            -c tools/proto-convert/src/config/protobuf-generator-config.yaml

      - name: Generate Compatibility Report
        id: merge_report
        timeout-minutes: 10
        run: |
          set -e
          npm run postprocessing:dry-run || true

          REPORT_PATH="merge-report.md"
          if [ -f "$REPORT_PATH" ]; then
            cat "$REPORT_PATH" > report.md
          else
            echo "âœ… No compatibility issues detected." > report.md
          fi

      - name: Upload Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: proto-compatibility-report
          path: report.md
