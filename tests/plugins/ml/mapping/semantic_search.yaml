$schema: ../../../../json_schemas/test_story.schema.yaml

description: Test semantic search functionality with semantic field type.
version: '>= 3.1'

prologues:
  # Register and deploy a model
  - id: register_model
    path: /_plugins/_ml/models/_register
    method: POST
    request:
      payload:
        name: huggingface/sentence-transformers/all-MiniLM-L12-v2
        version: 1.0.1
        model_format: TORCH_SCRIPT
    response:
      status: 200
    output:
      model_id: payload.model_id
      task_id: payload.task_id

  - path: /_plugins/_ml/tasks/{task_id}
    method: GET
    parameters:
      task_id: ${register_model.task_id}
    response:
      status: 200
      payload:
        state: COMPLETED
    retry:
      count: 5
      wait: 3000

  - id: deploy_model
    path: /_plugins/_ml/models/{model_id}/_deploy
    method: POST
    parameters:
      model_id: ${register_model.model_id}
    response:
      status: 200
    output:
      deploy_task_id: payload.task_id

  - path: /_plugins/_ml/tasks/{task_id}
    method: GET
    parameters:
      task_id: ${deploy_model.deploy_task_id}
    response:
      status: 200
      payload:
        state: COMPLETED
    retry:
      count: 5
      wait: 3000

  # Create index with semantic field
  - path: /{index}
    method: PUT
    parameters:
      index: semantic_search_test
    request:
      payload:
        settings:
          index:
            number_of_shards: 1
            number_of_replicas: 0
        mappings:
          properties:
            title:
              type: text
            content:
              type: semantic
              model_id: ${register_model.model_id}
            category:
              type: keyword
    response:
      status: 200

  # Index sample documents
  - path: /_bulk
    method: POST
    parameters:
      refresh: 'true'
    request:
      content_type: application/x-ndjson
      payload:
        - {index: {_index: semantic_search_test, _id: '1'}}
        - {title: Introduction to Machine Learning, content: Machine learning is a subset of artificial intelligence that enables systems to learn from data, category: AI}
        - {index: {_index: semantic_search_test, _id: '2'}}
        - {title: Deep Learning Fundamentals, content: Deep learning uses neural networks with multiple layers to process complex patterns, category: AI}
        - {index: {_index: semantic_search_test, _id: '3'}}
        - {title: Natural Language Processing, content: NLP enables computers to understand and process human language, category: AI}
        - {index: {_index: semantic_search_test, _id: '4'}}
        - {title: Database Management, content: Databases store and organize data for efficient retrieval and management, category: Database}
        - {index: {_index: semantic_search_test, _id: '5'}}
        - {title: Cloud Computing Basics, content: Cloud computing provides on-demand access to computing resources over the internet, category: Cloud}
    response:
      status: 200
      payload:
        errors: false

epilogues:
  - path: /semantic_search_test
    method: DELETE
    status: [200, 404]
  - path: /_plugins/_ml/models/{model_id}
    method: DELETE
    parameters:
      model_id: ${register_model.model_id}
    status: [200, 404]

chapters:
  # Test 1: Basic search on semantic field
  - synopsis: Search documents using match_all query.
    path: /{index}/_search
    method: POST
    parameters:
      index: semantic_search_test
    request:
      payload:
        query:
          match_all: {}
    response:
      status: 200
      payload:
        hits:
          total:
            value: 5

  # Test 2: Search with specific category
  - synopsis: Search documents by category.
    path: /{index}/_search
    method: POST
    parameters:
      index: semantic_search_test
    request:
      payload:
        query:
          term:
            category: AI
    response:
      status: 200
      payload:
        hits:
          total:
            value: 3

  # Test 3: Full-text search on title field
  - synopsis: Search documents by title using full-text search.
    path: /{index}/_search
    method: POST
    parameters:
      index: semantic_search_test
    request:
      payload:
        query:
          match:
            title: machine learning
    response:
      status: 200
      payload:
        hits:
          total:
            value: 1
          hits:
            - _id: '1'

  # Test 4: Aggregation on category field
  - synopsis: Aggregate documents by category.
    path: /{index}/_search
    method: POST
    parameters:
      index: semantic_search_test
    request:
      payload:
        size: 0
        aggs:
          categories:
            terms:
              field: category
    response:
      status: 200
      payload:
        aggregations:
          categories:
            buckets:
              - key: AI
                doc_count: 3

  # Test 5: Count documents
  - synopsis: Count all documents in semantic index.
    warnings:
      multiple-paths-detected: false
    path: /{index}/_count
    method: POST
    parameters:
      index: semantic_search_test
    request:
      payload:
        query:
          match_all: {}
    response:
      status: 200
      payload:
        count: 5

  # Test 6: Get specific document
  - synopsis: Retrieve a specific document by ID.
    warnings:
      multiple-paths-detected: false
    path: /{index}/_doc/{id}
    method: GET
    parameters:
      index: semantic_search_test
      id: '1'
    response:
      status: 200
      payload:
        _id: '1'
        found: true
        _source:
          title: Introduction to Machine Learning
          category: AI

  # Test 7: Multi-match search across fields
  - synopsis: Search across multiple fields.
    warnings:
      multiple-paths-detected: false
    path: /{index}/_search
    method: POST
    parameters:
      index: semantic_search_test
    request:
      payload:
        query:
          multi_match:
            query: neural networks
            fields: [content,title]
    response:
      status: 200

  # Test 8: Boolean query combining conditions
  - synopsis: Use boolean query with semantic field.
    warnings:
      multiple-paths-detected: false
    path: /{index}/_search
    method: POST
    parameters:
      index: semantic_search_test
    request:
      payload:
        query:
          bool:
            must:
              - match:
                  title: learning
            filter:
              - term:
                  category: AI
    response:
      status: 200
      payload:
        hits:
          total:
            value: 2

