$schema: ../../../../json_schemas/test_story.schema.yaml

description: Test basic semantic field type mappings.
version: '>= 3.1'

prologues:
  # Register a simple model for testing
  - id: register_model
    path: /_plugins/_ml/models/_register
    method: POST
    request:
      payload:
        name: huggingface/sentence-transformers/all-MiniLM-L12-v2
        version: 1.0.1
        model_format: TORCH_SCRIPT
    response:
      status: 200
    output:
      model_id: payload.model_id
      task_id: payload.task_id

  # Wait for model registration
  - path: /_plugins/_ml/tasks/{task_id}
    method: GET
    parameters:
      task_id: ${register_model.task_id}
    response:
      status: 200
      payload:
        state: COMPLETED
    retry:
      count: 5
      wait: 3000

  # Deploy the model
  - id: deploy_model
    path: /_plugins/_ml/models/{model_id}/_deploy
    method: POST
    parameters:
      model_id: ${register_model.model_id}
    response:
      status: 200
    output:
      deploy_task_id: payload.task_id

  # Wait for model deployment
  - path: /_plugins/_ml/tasks/{task_id}
    method: GET
    parameters:
      task_id: ${deploy_model.deploy_task_id}
    response:
      status: 200
      payload:
        state: COMPLETED
    retry:
      count: 5
      wait: 3000

epilogues:
  - path: /semantic_test_index
    method: DELETE
    status: [200, 404]
  - path: /semantic_test_multi
    method: DELETE
    status: [200, 404]
  - path: /_plugins/_ml/models/{model_id}
    method: DELETE
    parameters:
      model_id: ${register_model.model_id}
    status: [200, 404]

chapters:
  # Test 1: Create an index with a basic semantic field
  - synopsis: Create an index with a semantic field mapping.
    path: /{index}
    method: PUT
    parameters:
      index: semantic_test_index
    request:
      payload:
        mappings:
          properties:
            content:
              type: semantic
              model_id: ${register_model.model_id}
    response:
      status: 200
      payload:
        acknowledged: true

  # Test 2: Verify the mapping was created correctly
  - synopsis: Get mappings to verify semantic field.
    path: /{index}/_mapping
    method: GET
    parameters:
      index: semantic_test_index
    response:
      status: 200
      payload:
        semantic_test_index:
          mappings:
            properties:
              content:
                type: semantic

  # Test 3: Get specific semantic field mapping
  - synopsis: Get specific semantic field mapping.
    path: /{index}/_mapping/field/{fields}
    method: GET
    parameters:
      index: semantic_test_index
      fields: content
    response:
      status: 200
      payload:
        semantic_test_index:
          mappings:
            content:
              full_name: content
              mapping:
                content:
                  type: semantic

  # Test 4: Index a document with semantic field
  - synopsis: Index a document with semantic field content.
    path: /{index}/_doc/{id}
    method: PUT
    parameters:
      index: semantic_test_index
      id: '1'
      refresh: 'true'
    request:
      payload:
        content: This is a test document for semantic search
        title: Test Document
    response:
      status: 201

  # Test 5: Create an index with multiple semantic fields
  - synopsis: Create an index with multiple semantic fields.
    path: /{index}
    method: PUT
    parameters:
      index: semantic_test_multi
    request:
      payload:
        mappings:
          properties:
            title_semantic:
              type: semantic
              model_id: ${register_model.model_id}
            description_semantic:
              type: semantic
              model_id: ${register_model.model_id}
            category:
              type: keyword
    response:
      status: 200
      payload:
        acknowledged: true

  # Test 6: Update mapping to add another semantic field
  - synopsis: Update mapping to add another semantic field.
    path: /{index}/_mapping
    method: PUT
    parameters:
      index: semantic_test_index
    request:
      payload:
        properties:
          summary:
            type: semantic
            model_id: ${register_model.model_id}
    response:
      status: 200
      payload:
        acknowledged: true

  # Test 7: Verify updated mapping includes new field
  - synopsis: Verify mapping includes newly added semantic field.
    path: /{index}/_mapping
    method: GET
    parameters:
      index: semantic_test_index
    response:
      status: 200
      payload:
        semantic_test_index:
          mappings:
            properties:
              content:
                type: semantic
              summary:
                type: semantic

