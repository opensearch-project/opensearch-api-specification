$schema: ../../../../../../json_schemas/test_story.schema.yaml

description: Test searching for memories within a memory container.
warnings:
  invalid-path-detected: false
version: '>= 3.3'
prologues:
  - path: /_plugins/_ml/memory_containers/_create
    id: create_mem_container
    method: POST
    request:
      payload:
        name: Test memory container
        description: Test memory container
        configuration:
          index_prefix: test_mem_container
          use_system_index: False
          disable_session: False
          index_settings:
            session_index:
              index:
                number_of_shards: '1'
                auto_expand_replicas: 0-all
            working_memory_index:
              index:
                number_of_shards: '1'
                auto_expand_replicas: 0-all
    output:
      mem_container: payload.memory_container_id
  - path: /_plugins/_ml/memory_containers/{memory_container_id}/memories
    id: add_conversational_payload
    method: POST
    parameters:
      memory_container_id: ${create_mem_container.mem_container}
    request:
      payload:
        messages: 
          - role: user
            content:
              - text: I'm Bob, I like swimming
                type: text
          - role: assistant
            content:
              - text: Nice, hope you enjoy your life
                type: text
        namespace:
          user_id: bob
        metadata:
          status: checkpoint
          branch:
            branch_name: high
            root_event_id: event123
        tags:
          topic: personal info
        payload_type: conversational
    output:
      working_memory_id: payload.working_memory_id
epilogues:
  - path: /_plugins/_ml/memory_containers/{memory_container_id}/memories/{type}/{id}
    method: DELETE
    status: [200, 404]
    parameters:
      memory_container_id: ${create_mem_container.mem_container}
      type: working
      id: ${add_conversational_payload.working_memory_id}
  - path: /_plugins/_ml/memory_containers/{memory_container_id}
    method: DELETE
    status: [200, 404]
    parameters:
      memory_container_id: ${create_mem_container.mem_container}
chapters:
  - synopsis: Search for memories within a memory container.
    path: /_plugins/_ml/memory_containers/{memory_container_id}/memories/{type}/_search
    method: GET
    parameters:
      memory_container_id: ${create_mem_container.mem_container}
      type: working
    request:
      payload:
        query:
          bool:
            must:
              - term:
                  namespace.user_id: bob
        sort:
          - created_time:
              order: desc
    response:
      status: 200
      payload:
        hits:
          total:
            value: 1